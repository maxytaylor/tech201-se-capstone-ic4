CREATE OR REPLACE TABLE `max_ic4_raw.mixpanel_users_sync` AS
SELECT
  -- Canonical user id for Mixpanel profile
  COALESCE(m.user_id, u.distinct_id) AS user_id,

  -- Debug (optional but useful)
  CASE
    WHEN m.user_id IS NOT NULL THEN 'mapped_to_auth_uuid'
    ELSE 'fallback_to_profile_distinct_id'
  END AS id_resolution_type,

  u.* EXCEPT(distinct_id)
FROM `max_ic4_raw.max_raw_users` u
LEFT JOIN `max_ic4_raw.idmap_profile_to_user` m
  ON u.distinct_id = m.profile_distinct_id;
